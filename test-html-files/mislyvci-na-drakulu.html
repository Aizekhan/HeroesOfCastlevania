<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏—Å–ª–∏–≤—Ü—ñ –Ω–∞ –î—Ä–∞–∫—É–ª—É</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .game-container { max-width: 1800px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255,107,107,0.7);
            font-size: 2.5em;
        }
        
        .game-setup {
            background: rgba(255,255,255,0.05);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .heroes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .hero-card {
            background: linear-gradient(135deg, #2d3436 0%, #1e272e 100%);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        .hero-card:hover {
            transform: translateY(-5px);
            border-color: #ffd700;
            box-shadow: 0 10px 30px rgba(255,215,0,0.3);
        }
        .hero-card.selected {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
        }
        
        .game-board { display: none; gap: 15px; }
        .game-board.active { 
            display: grid; 
            grid-template-columns: 300px 1fr 350px;
        }
        .panel {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .board-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 1200px; 
            margin: 0 auto;
            background: linear-gradient(135deg, #8B4513, #CD853F, #D2B48C);
            border-radius: 15px;
            border: 8px solid #654321;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            min-height: 600px;
        }
        .board-image {
            width: 100%;
            height: auto;
            min-height: 600px;
            display: block;
            border-radius: 15px;
            background: linear-gradient(135deg, #8B4513, #CD853F, #D2B48C);
        }
        .board-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(139, 69, 19, 0.1) 2px, transparent 3px),
                radial-gradient(circle at 80% 70%, rgba(205, 133, 63, 0.1) 2px, transparent 3px),
                radial-gradient(circle at 60% 20%, rgba(160, 82, 45, 0.1) 1px, transparent 2px);
            background-size: 50px 50px, 80px 80px, 30px 30px;
        }
        
        .player-token {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.9), 0 0 20px rgba(255,255,255,0.7);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* –ü–ª–∞–≤–Ω—ñ—à–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è */
            z-index: 100;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        .player-token.active {
            animation: pulse 1.5s infinite;
            border-width: 5px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.9), 0 0 30px rgba(255,215,0,1);
            width: 55px;
            height: 55px;
            font-size: 24px;
        }
        .player-token.moving {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.9), 0 0 25px rgba(255,215,0,0.8);
            z-index: 110;
        }
        @keyframes pulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1); 
                box-shadow: 0 6px 25px rgba(0,0,0,0.9), 0 0 30px rgba(255,215,0,1);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2); 
                box-shadow: 0 6px 30px rgba(0,0,0,0.9), 0 0 40px rgba(255,215,0,1);
            }
        }
        
        button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        button.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #2d3436 0%, #1e272e 100%);
            padding: 40px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .inventory-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .inventory-item:hover {
            background: rgba(255,255,255,0.2);
            border-color: #ffd700;
            transform: translateY(-3px);
        }
        .inventory-item.usable {
            border-color: #27ae60;
        }
        .inventory-item .count {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin: 15px 0; 
        }
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-item .label {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .artifacts-display { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin: 10px 0; 
        }
        .artifact-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255,215,0,0.3);
            border: 2px solid #fff;
        }
        .artifact-badge.level-1 { background: linear-gradient(135deg, #3498db 0%, #5dade2 100%); color: #fff; }
        .artifact-badge.level-2 { background: linear-gradient(135deg, #27ae60 0%, #58d68d 100%); color: #fff; }
        .artifact-badge.level-3 { background: linear-gradient(135deg, #e74c3c 0%, #ec7063 100%); color: #fff; }
        .artifact-badge.level-4 { background: linear-gradient(135deg, #8e44ad 0%, #bb8fce 100%); color: #fff; }
        .artifact-badge.level-5 { background: linear-gradient(135deg, #f39c12 0%, #f8c471 100%); color: #333; }
        
        .companions-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin: 10px 0; 
        }
        .companion-badge {
            background: linear-gradient(135deg, #16a085 0%, #48c9b0 100%);
            color: #fff;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(22,160,133,0.3);
        }
        .companion-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22,160,133,0.5);
        }
        
        .log {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9em;
            color: #ccc;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .dice-display {
            text-align: center;
            margin: 20px 0;
            font-size: 2em;
            color: #ffd700;
            font-weight: bold;
        }
        
        .player-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid;
        }
        .player-item.current {
            background: rgba(255,215,0,0.1);
            border-left-color: #ffd700;
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
        }
        
        .ability-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 0;
            width: 100%;
            text-align: left;
            transition: all 0.3s;
        }
        .ability-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            transform: translateX(5px);
        }
        .ability-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        h2, h3 { 
            margin-bottom: 15px; 
            color: #ffd700; 
        }
        
        .hero-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .armor { color: #3498db; }
        .start-gold { color: #ffd700; }
        .ability-text {
            font-size: 0.85em;
            color: #aaa;
            font-style: italic;
            margin-top: 8px;
        }
        
        select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #2d3436;
            color: #fff;
            font-size: 1em;
            width: 100%;
            margin: 10px 0;
        }
        
        .section-divider {
            border-top: 2px solid rgba(255,255,255,0.1);
            margin: 20px 0;
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üßõ –ú–∏—Å–ª–∏–≤—Ü—ñ –Ω–∞ –î—Ä–∞–∫—É–ª—É üó°Ô∏è</h1>
        
        <div class="game-setup" id="gameSetup">
            <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏</h2>
            <div style="margin-bottom: 20px;">
                <label>
                    –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤:
                    <select id="playerCount" onchange="updateHeroSelection()">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4" selected>4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </label>
            </div>
            <h3>–í–∏–±–µ—Ä—ñ—Ç—å –≥–µ—Ä–æ—ó–≤:</h3>
            <div class="heroes-grid" id="heroesGrid"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="startGame()" style="font-size: 1.2em; padding: 15px 40px;">
                    üéÆ –ü–æ—á–∞—Ç–∏ –≥—Ä—É
                </button>
            </div>
        </div>
        
        <div class="game-board" id="gameBoard">
            <div class="panel">
                <h3>–ì—Ä–∞–≤—Ü—ñ</h3>
                <div id="playersList"></div>
            </div>
            
            <div class="panel">
                <div class="board-wrapper">
                    <img id="boardImage" src="board.png" alt="Game Board" class="board-image">
                    <div class="board-overlay" id="boardOverlay"></div>
                </div>
                <div class="log" id="gameLog"></div>
            </div>
            
            <div class="panel">
                <h3>–ü–æ—Ç–æ—á–Ω–∏–π –≥—Ä–∞–≤–µ—Ü—å</h3>
                <div id="currentPlayerInfo"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="rollDice()" id="rollBtn">üé≤ –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫</button>
                    <div class="dice-display" id="diceDisplay"></div>
                    <button onclick="endTurn()" id="endTurnBtn" style="display: none;">
                        ‚úÖ –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ —Ö—ñ–¥
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—Ö–æ–¥—É –≤ –º—ñ—Å—Ç–æ —è–∫—â–æ —Å—Ç–æ—ó–º–æ –Ω–∞ –Ω—å–æ–º—É -->
                    <button onclick="enterCityFromLocation()" id="enterCityBtn" style="display: none;" class="secondary">
                        üèõÔ∏è –ó–∞–π—Ç–∏ –≤ –º—ñ—Å—Ç–æ
                    </button>
                </div>
                
                <div class="section-divider">
                    <h3>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä —Ç–∞ –≤–º—ñ–Ω–Ω—è</h3>
                    <button onclick="showInventory()" class="secondary">
                        üéí –í—ñ–¥–∫—Ä–∏—Ç–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä
                    </button>
                    <button onclick="showAbilities()" class="secondary">
                        ‚ö° –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≤–º—ñ–Ω–Ω—è
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
    <div class="modal" id="monsterModal">
        <div class="modal-content">
            <h2>‚öîÔ∏è –ë—ñ–π –∑ –º–æ–Ω—Å—Ç—Ä–æ–º!</h2>
            <div id="monsterContent"></div>
        </div>
    </div>
    
    <div class="modal" id="ruinsModal">
        <div class="modal-content">
            <h2>üèõÔ∏è –†—É—ó–Ω–∏</h2>
            <div id="ruinsContent"></div>
        </div>
    </div>
    
    <div class="modal" id="cityModal">
        <div class="modal-content">
            <h2>üèõÔ∏è –ú—ñ—Å—Ç–æ</h2>
            <div id="cityContent"></div>
        </div>
    </div>
    
    <div class="modal" id="goldModal">
        <div class="modal-content">
            <h2>üí∞ –ó–Ω–∞—Ö—ñ–¥–∫–∞!</h2>
            <div id="goldContent"></div>
        </div>
    </div>
    
    <div class="modal" id="adventureModal">
        <div class="modal-content">
            <h2>üî• –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥!</h2>
            <div id="adventureContent"></div>
        </div>
    </div>
    
    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <h2>üéí –Ü–Ω–≤–µ–Ω—Ç–∞—Ä</h2>
            <div id="inventoryContent"></div>
        </div>
    </div>
    
    <div class="modal" id="abilitiesModal">
        <div class="modal-content">
            <h2>‚ö° –í–º—ñ–Ω–Ω—è</h2>
            <div id="abilitiesContent"></div>
        </div>
    </div>

    <script>
// –¢–∏–ø–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤
const ARTIFACT_TYPES = [
    { name: '–í–æ–≥–æ–Ω—å', icon: 'üî•', color: '#ff4757' },
    { name: '–í–æ–¥–∞', icon: 'üíß', color: '#3742fa' },
    { name: '–ü–æ–≤—ñ—Ç—Ä—è', icon: 'üå™Ô∏è', color: '#57606f' },
    { name: '–ü—Ä–∏—Ä–æ–¥–∞', icon: 'üåø', color: '#2ed573' },
    { name: '–ë–ª–∏—Å–∫–∞–≤–∫–∞', icon: '‚ö°', color: '#ffd700' },
    { name: '–î—Ä–∞–∫–æ–Ω', icon: 'üê≤', color: '#8e44ad' }
];

// –î–ê–ù–Ü –ì–†–ò
const HEROES = [
    { name: '–í–æ—ó–Ω', armor: 4, gold: 7, color: '#ff6b6b', ability: '+1 —É –±–æ—é –ø—Ä–æ—Ç–∏ –º–æ–Ω—Å—Ç—Ä—ñ–≤ 4-5 —Ä—ñ–≤–Ω—è', abilityType: 'passive' },
    { name: '–ù–∞–π–º–∞–Ω–µ—Ü—å', armor: 4, gold: 5, color: '#ff8a5b', ability: '+2üí∞ –Ω–∞ –ª–æ–∫–∞—Ü—ñ—ó "–ó–Ω–∞—Ö—ñ–¥–∫–∞"', abilityType: 'passive' },
    { name: '–Ü–ª—é–∑—ñ–æ–Ω—ñ—Å—Ç', armor: 1, gold: 9, color: '#8e44ad', ability: '–ú–æ–∂–µ –º–∞—Ç–∏ 2 —Å—É–ø—É—Ç–Ω–∏–∫–∏', abilityType: 'passive' },
    { name: '–ú–∞–≥', armor: 1, gold: 9, color: '#9b59b6', ability: '–ü–µ—Ä–µ–∫–∏–¥–∞—î –°—É–≤–æ—ó –£–¥–∞—á—ñ', abilityType: 'active' },
    { name: '–ê–ª—Ö—ñ–º—ñ–∫', armor: 2, gold: 8, color: '#27ae60', ability: '–í –†—É—ó–Ω–∞—Ö –º–æ–∂–µ –≤–∑—è—Ç–∏ 2 –∫–∞—Ä—Ç–∏', abilityType: 'passive' },
    { name: '–ö—É–∑–Ω–µ—Ü—å', armor: 4, gold: 6, color: '#f39c12', ability: '2 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ ‚Üí +1 —Ä—ñ–≤–µ–Ω—å', abilityType: 'active' },
    { name: '–ó–ª–æ–¥—ñ–π', armor: 2, gold: 7, color: '#34495e', ability: '–ú–æ–∂–µ –≤–∫—Ä–∞—Å—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç', abilityType: 'active' },
    { name: '–¢–æ—Ä–≥–æ–≤–µ—Ü—å', armor: 1, gold: 10, color: '#e67e22', ability: '–ó–Ω–∏–∂–∫–∞ -3üí∞ –≤ –ú—ñ—Å—Ç—ñ', abilityType: 'passive' },
    { name: '–ú–∏—Å–ª–∏–≤–µ—Ü—å', armor: 1, gold: 6, color: '#16a085', ability: '–°—Ç—Ä–∏–±–æ–∫ –Ω–∞ "–ú–æ–Ω—Å—Ç—Ä–∞"', abilityType: 'active' },
    { name: '–ó–Ω–∞—Ö–∞—Ä', armor: 2, gold: 8, color: '#2ecc71', ability: '–ó–∞ –ø–µ—Ä–µ–º–æ–≥—É: +‚ö°+üí∞', abilityType: 'passive' }
];

const COMPANIONS = [
    { name: '–Ñ–¥–∏–Ω–æ—Ä—ñ–≥', ability: '–ü–æ–º—ñ–Ω—è–π –º—ñ—Å—Ü—è–º–∏ —Ü–∏—Ñ—Ä–∏ –∫—É–±–∏–∫–∞', type: 'active' },
    { name: '–ì—Ä–∏—Ñ–æ–Ω', ability: '–°—Ç—Ä–∏–±–æ–∫ –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á–æ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞', type: 'active' },
    { name: '–ö—ñ–Ω—å', ability: '+2 –∫—Ä–æ–∫–∏ –≤–ø–µ—Ä–µ–¥', type: 'active' },
    { name: '–í–æ–≤–∫', ability: '+1 —É –±–æ—é –ø—Ä–æ—Ç–∏ –º–æ–Ω—Å—Ç—Ä—ñ–≤ 1-3 —Ä—ñ–≤–Ω—è', type: 'passive' },
    { name: '–î—Ä–∞–∫–æ–Ω', ability: '–ü—ñ–¥ —á–∞—Å –±–æ—é: 1 –∑ 5 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –Ω–∞ –≤–∏–±—ñ—Ä', type: 'passive' },
    { name: '–ü–∞–≤—É–∫', ability: '–Ü–º—É–Ω—ñ—Ç–µ—Ç –≤—ñ–¥ —Ñ—ñ–∑–∏—á–Ω–∏—Ö –¥—ñ–π', type: 'passive' },
    { name: '–ß–µ—Ä–µ–ø–∞—Ö–∞', ability: '–Ü–º—É–Ω—ñ—Ç–µ—Ç –≤—ñ–¥ –ø–∞—Å—Ç–æ–∫', type: 'passive' },
    { name: '–í—ñ—Å–ª—é–∫', ability: '–ú–æ–∂–Ω–∞ –º–∞—Ç–∏ 6 –∫–∞—Ä—Ç (–∑–∞–º—ñ—Å—Ç—å 3)', type: 'passive' },
    { name: '–ë—ñ–ª–∫–∞', ability: '+1üí∞ –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –µ–ª—ñ–∫—Å–∏—Ä—ñ–≤/—Å—É–≤–æ—ó–≤', type: 'passive' }
];

const MONSTERS = [
    { name: '–ì–æ–±–ª—ñ–Ω', level: 1, gold: 1 },
    { name: '–ì—ñ–≥–∞–Ω—Ç—Å—å–∫–∏–π –ü–∞–≤—É–∫', level: 1, gold: 1 },
    { name: '–°–∫–µ–ª–µ—Ç–∏', level: 2, gold: 2 },
    { name: '–í–∞–º–ø—ñ—Ä—Å—å–∫–∏–π –ö–∞–∂–∞–Ω', level: 2, gold: 2 },
    { name: '–ì–∞—Ä–≥—É–ª—å—è', level: 3, gold: 3 },
    { name: '–¢—Ä–æ–ª—å', level: 3, gold: 3 },
    { name: '–í—ñ–¥—å–º–∞', level: 4, gold: 4 },
    { name: '–í–æ–≤–∫—É–ª–∞–∫', level: 4, gold: 4 },
    { name: '–ü—Ä–∏–≤–∏–¥', level: 5, gold: 5 },
    { name: '–í–∞–º–ø—ñ—Ä', level: 5, gold: 5 }
];

// –ü–æ–∑–∏—Ü—ñ—ó –¥–æ—à–∫–∏
const BOARD_POSITIONS = [];
const locationTypes = [
    { type: 'start' }, { type: 'gold', amount: 3 }, { type: 'ruins' }, { type: 'gold', amount: 2 },
    { type: 'gold', amount: 2 }, { type: 'city' }, { type: 'gold', amount: 1 }, { type: 'monster', level: 2 },
    { type: 'ruins' }, { type: 'adventure' }, { type: 'monster', level: 2 }, { type: 'adventure' },
    { type: 'city' }, { type: 'city' }, { type: 'monster', level: 3 }, { type: 'gold', amount: 3 },
    { type: 'gold', amount: 2 }, { type: 'ruins' }, { type: 'gold', amount: 2 }, { type: 'monster', level: 3 },
    { type: 'adventure' }, { type: 'gold', amount: 2 }, { type: 'monster', level: 3 }, { type: 'ruins' },
    { type: 'adventure' }, { type: 'gold', amount: 2 }, { type: 'city' }, { type: 'monster', level: 3 },
    { type: 'gold', amount: 2 }, { type: 'adventure' }, { type: 'gold', amount: 2 }, { type: 'city' },
    { type: 'ruins' }, { type: 'adventure' }, { type: 'gold', amount: 2 }, { type: 'monster', level: 4 },
    { type: 'gold', amount: 3 }, { type: 'city' }, { type: 'gold', amount: 2 }, { type: 'adventure' },
    { type: 'gold', amount: 2 }, { type: 'ruins' }, { type: 'monster', level: 4 }, { type: 'gold', amount: 2 },
    { type: 'city' }, { type: 'ruins' }, { type: 'monster', level: 4 }, { type: 'gold', amount: 3 },
    { type: 'adventure' }, { type: 'monster', level: 4 }, { type: 'gold', amount: 2 }, { type: 'city' },
    { type: 'ruins' }, { type: 'monster', level: 5 }, { type: 'adventure' }, { type: 'gold', amount: 1 },
    { type: 'ruins' }, { type: 'gold', amount: 2 }, { type: 'adventure' }, { type: 'gold', amount: 3 },
    { type: 'ruins' }, { type: 'monster', level: 5 }, { type: 'gold', amount: 3 }, { type: 'ruins' },
    { type: 'adventure' }, { type: 'monster', level: 5 }, { type: 'gold', amount: 2 }, { type: 'monster', level: 5 },
    { type: 'adventure' }, { type: 'monster', level: 5 }
];

// –ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∞ –∑–∏–≥–∑–∞–≥–æ–ø–æ–¥—ñ–±–Ω–∞ –∫–∞—Ä—Ç–∞
const cols = 14;
const rows = 5;
const marginX = 8.5; // 120px –≤—ñ–¥ –∫—Ä–∞—é —É –≤—ñ–¥—Å–æ—Ç–∫–∞—Ö (120/1400*100)
const marginY = 13.3; // 120px –≤—ñ–¥ –∫—Ä–∞—é —É –≤—ñ–¥—Å–æ—Ç–∫–∞—Ö (120/900*100) 
const spacingX = (100 - 2 * marginX) / (cols - 1); // –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∫–æ–ª–æ–Ω–∫–∞–º–∏ —É –≤—ñ–¥—Å–æ—Ç–∫–∞—Ö
const spacingY = (100 - 2 * marginY - 16.7) / (rows - 1); // –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —Ä—è–¥–∫–∞–º–∏ —É –≤—ñ–¥—Å–æ—Ç–∫–∞—Ö (–≤—ñ–¥–Ω—ñ–º–∞—î–º–æ 150px –¥–ª—è –∑–∞–º–∫—É)

for (let i = 0; i < locationTypes.length; i++) {
    const row = Math.floor(i / cols);
    const col = i % cols;
    
    let x, y;
    if (row % 2 === 0) {
        // –õ—ñ–≤–æ—Ä—É—á –Ω–∞–ø—Ä–∞–≤–æ
        x = marginX + col * spacingX;
    } else {
        // –ü—Ä–∞–≤–æ—Ä—É—á –Ω–∞–ª—ñ–≤–æ (–∑–∏–≥–∑–∞–≥)
        x = marginX + (cols - 1 - col) * spacingX;
    }
    y = marginY + row * spacingY;
    
    BOARD_POSITIONS.push({ x: x, y: y, ...locationTypes[i] });
}

// –ó–∞–º–æ–∫ –≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É
BOARD_POSITIONS.push({ 
    x: 50, 
    y: 100 - 13.3, // 86.7% –≤—ñ–¥ –≤–µ—Ä—Ö—É (120px –≤—ñ–¥ –Ω–∏–∑—É)
    type: 'castle' 
});

// –°—Ç–∞–Ω –≥—Ä–∏
let gameState = {
    players: [], currentPlayerIndex: 0, selectedHeroes: [],
    diceRolled: false, moveComplete: false, pendingActions: []
};

// –§—É–Ω–∫—Ü—ñ—ó
function loadBoardImage() {
    const img = document.getElementById('boardImage');
    img.src = 'board.png';
    img.onload = () => console.log('Board loaded!');
    img.onerror = () => alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏!');
}

function updateHeroSelection() {
    const count = parseInt(document.getElementById('playerCount').value);
    const grid = document.getElementById('heroesGrid');
    grid.innerHTML = '';
    for (let i = 0; i < count; i++) {
        const card = document.createElement('div');
        card.className = 'hero-card';
        card.innerHTML = `
            <h3>–ì—Ä–∞–≤–µ—Ü—å ${i + 1}</h3>
            <select id="heroSelect${i}" onchange="selectHero(${i}, this.value)">
                <option value="">- –í–∏–±–µ—Ä—ñ—Ç—å –≥–µ—Ä–æ—è -</option>
                ${HEROES.map((h, idx) => `<option value="${idx}">${h.name}</option>`).join('')}
            </select>
            <div id="heroPreview${i}" style="margin-top: 15px;"></div>
        `;
        grid.appendChild(card);
    }
}

function selectHero(playerIndex, heroIndex) {
    if (heroIndex === '') return;
    const hero = HEROES[heroIndex];
    const preview = document.getElementById(`heroPreview${playerIndex}`);
    const card = document.getElementById(`heroSelect${playerIndex}`).parentElement;
    preview.innerHTML = `
        <div class="hero-stats">
            <span class="armor">üõ°Ô∏è ${hero.armor}</span>
            <span class="start-gold">üí∞ ${hero.gold}</span>
        </div>
        <div class="ability-text">${hero.ability}</div>
    `;
    card.classList.add('selected');
    gameState.selectedHeroes[playerIndex] = heroIndex;
}

function startGame() {
    const playerCount = parseInt(document.getElementById('playerCount').value);
    for (let i = 0; i < playerCount; i++) {
        if (!gameState.selectedHeroes[i] && gameState.selectedHeroes[i] !== 0) {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å –≥–µ—Ä–æ—ó–≤ –¥–ª—è –≤—Å—ñ—Ö –≥—Ä–∞–≤—Ü—ñ–≤!'); return;
        }
    }
    gameState.players = [];
    for (let i = 0; i < playerCount; i++) {
        const hero = HEROES[gameState.selectedHeroes[i]];
        gameState.players.push({
            id: i, name: `–ì—Ä–∞–≤–µ—Ü—å ${i + 1}`, hero: hero.name, heroData: hero, color: hero.color,
            position: 0, health: 3, gold: hero.gold, armor: hero.armor, 
            artifacts: {
                // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: artifacts[type][level] = count
                '–í–æ–≥–æ–Ω—å': {}, '–í–æ–¥–∞': {}, '–ü–æ–≤—ñ—Ç—Ä—è': {}, '–ü—Ä–∏—Ä–æ–¥–∞': {}, '–ë–ª–∏—Å–∫–∞–≤–∫–∞': {}, '–î—Ä–∞–∫–æ–Ω': {}
            },
            companions: [], weapons: { rope: 0, axe: 0, dagger: 0, ring: 0 },
            elixirs: { speed: 0, luck: 0 }, traps: 5, adventureCards: [], usedLuckScrolls: []
        });
    }
    document.getElementById('gameSetup').style.display = 'none';
    document.getElementById('gameBoard').classList.add('active');
    document.querySelector('h1').style.display = 'none';
    updateDisplay();
    addLog('üéÆ –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å!');
    addLog(`--- ${gameState.players[gameState.currentPlayerIndex].name} ---`);
}

function updateDisplay() {
    updatePlayersList(); updateCurrentPlayerInfo(); updatePlayerTokens();
}

function updatePlayersList() {
    const list = document.getElementById('playersList');
    list.innerHTML = '';
    gameState.players.forEach((player, index) => {
        const artifactsList = [];
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –ø–æ —Ç–∏–ø–∞—Ö
        ARTIFACT_TYPES.forEach(type => {
            const typeArtifacts = player.artifacts[type.name];
            if (typeArtifacts && Object.keys(typeArtifacts).length > 0) {
                let typeDisplay = `<div style="margin: 4px 0;"><strong>${type.icon} ${type.name}:</strong> `;
                const levels = [];
                for (let level = 1; level <= 5; level++) {
                    const count = typeArtifacts[level] || 0;
                    if (count > 0) {
                        levels.push(`${level}‚òÖ√ó${count}`);
                    }
                }
                if (levels.length > 0) {
                    typeDisplay += levels.join(', ');
                    typeDisplay += '</div>';
                    artifactsList.push(typeDisplay);
                }
            }
        });

        const playerItem = document.createElement('div');
        playerItem.className = `player-item ${index === gameState.currentPlayerIndex ? 'current' : ''}`;
        playerItem.style.borderLeftColor = player.color;
        playerItem.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong>${player.name}</strong>
                <div style="font-size: 0.9em; opacity: 0.8;">${player.hero}</div>
            </div>
            <div style="font-size: 0.85em; display: flex; gap: 15px;">
                <span>‚ù§Ô∏è ${player.health}</span> <span>üí∞ ${player.gold}</span>
                <span>üõ°Ô∏è ${player.armor}</span> <span>üìç ${player.position}</span>
            </div>
            ${artifactsList.length > 0 ? `<div style="margin-top: 8px; font-size: 0.8em;">${artifactsList.join('')}</div>` : ''}
        `;
        list.appendChild(playerItem);
    });
}

function updateCurrentPlayerInfo() {
    const player = gameState.players[gameState.currentPlayerIndex];
    const info = document.getElementById('currentPlayerInfo');
    
    // –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –ø–æ —Ç–∏–ø–∞—Ö
    let artifactsDisplay = '';
    ARTIFACT_TYPES.forEach(type => {
        const typeArtifacts = player.artifacts[type.name];
        if (typeArtifacts && Object.keys(typeArtifacts).length > 0) {
            let hasArtifacts = false;
            let typeHtml = `<div style="margin: 8px 0;"><strong>${type.icon} ${type.name}:</strong> `;
            const badges = [];
            
            for (let level = 1; level <= 5; level++) {
                const count = typeArtifacts[level] || 0;
                if (count > 0) {
                    hasArtifacts = true;
                    badges.push(`<span class="artifact-badge level-${level}" style="background-color: ${type.color}; color: white; margin: 2px;">${level}‚òÖ x${count}</span>`);
                }
            }
            
            if (hasArtifacts) {
                typeHtml += badges.join(' ') + '</div>';
                artifactsDisplay += typeHtml;
            }
        }
    });
    
    info.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 2px solid ${player.color};">
            <h2 style="margin-bottom: 10px;">${player.name}</h2>
            <div style="font-size: 1.2em; margin-bottom: 10px;">‚öîÔ∏è ${player.hero}</div>
            <div class="stats-grid">
                <div class="stat-item"><div class="label">–ó–¥–æ—Ä–æ–≤'—è</div><div class="value" style="color: #e74c3c;">‚ù§Ô∏è ${player.health}</div></div>
                <div class="stat-item"><div class="label">–ó–æ–ª–æ—Ç–æ</div><div class="value" style="color: #ffd700;">üí∞ ${player.gold}</div></div>
                <div class="stat-item"><div class="label">–ë—Ä–æ–Ω—è</div><div class="value" style="color: #3498db;">üõ°Ô∏è ${player.armor}</div></div>
                <div class="stat-item"><div class="label">–ü–∞—Å—Ç–∫–∏</div><div class="value">üéØ ${player.traps}</div></div>
            </div>
            ${artifactsDisplay ? `<div style="margin-top: 15px;"><strong>–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–∏:</strong>${artifactsDisplay}</div>` : ''}
            ${player.companions.length > 0 ? `<div style="margin-top: 15px;"><strong>–°—É–ø—É—Ç–Ω–∏–∫–∏:</strong><div class="companions-list">${player.companions.map(c => `<span class="companion-badge" title="${c.ability}">${c.name}</span>`).join('')}</div></div>` : ''}
            <div style="margin-top: 15px; font-size: 0.9em;">
                <div>‚ö° –ï–ª—ñ–∫—Å–∏—Ä–∏ —à–≤–∏–¥–∫–æ—Å—Ç—ñ: ${player.elixirs.speed}</div>
                <div>üçÄ –°—É–≤—ñ–π —É–¥–∞—á—ñ: ${player.elixirs.luck}</div>
                <div>üÉè –ö–∞—Ä—Ç–∏ –ø—Ä–∏–≥–æ–¥: ${player.adventureCards.length}</div>
            </div>
        </div>
    `;
    const rollBtn = document.getElementById('rollBtn'), endTurnBtn = document.getElementById('endTurnBtn');
    const enterCityBtn = document.getElementById('enterCityBtn');
    
    rollBtn.disabled = gameState.diceRolled || gameState.moveComplete;
    rollBtn.style.opacity = (gameState.diceRolled || gameState.moveComplete) ? '0.5' : '1';
    endTurnBtn.style.display = gameState.moveComplete ? 'inline-block' : 'none';
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥—É –≤ –º—ñ—Å—Ç–æ —è–∫—â–æ —Å—Ç–æ—ó–º–æ –Ω–∞ –ª–æ–∫–∞—Ü—ñ—ó "–º—ñ—Å—Ç–æ"
    const currentLocation = BOARD_POSITIONS[player.position];
    if (currentLocation.type === 'city' && gameState.moveComplete) {
        enterCityBtn.style.display = 'inline-block';
    } else {
        enterCityBtn.style.display = 'none';
    }
}

function updatePlayerTokens(animate = false) {
    const overlay = document.getElementById('boardOverlay');
    if (!animate) overlay.innerHTML = '';
    gameState.players.forEach((player, index) => {
        const pos = BOARD_POSITIONS[player.position];
        let token = document.getElementById(`token-${player.id}`);
        if (!token) {
            token = document.createElement('div');
            token.id = `token-${player.id}`;
            token.className = 'player-token';
            overlay.appendChild(token);
        }
        
        // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å —Ä—É—Ö—É –ø—ñ–¥ —á–∞—Å –∞–Ω—ñ–º–∞—Ü—ñ—ó
        const wasMoving = token.classList.contains('moving');
        token.className = `player-token ${index === gameState.currentPlayerIndex ? 'active' : ''}`;
        if (animate && !wasMoving) {
            token.classList.add('moving');
            setTimeout(() => token.classList.remove('moving'), 400);
        }
        
        token.style.backgroundColor = player.color;
        const heroSymbols = ['‚öîÔ∏è', 'üó°Ô∏è', 'üé≠', 'üîÆ', '‚öóÔ∏è', 'üî®', 'üóùÔ∏è', 'üí∞', 'üèπ', 'üåø'];
        const heroIndex = HEROES.findIndex(h => h.name === player.hero);
        token.textContent = heroSymbols[heroIndex] || (player.id + 1);
        token.style.fontSize = '24px';
        const samePos = gameState.players.filter(p => p.position === player.position);
        let offsetX = 0, offsetY = 0;
        if (samePos.length > 1) {
            const idx = samePos.indexOf(player);
            const angle = (idx / samePos.length) * Math.PI * 2;
            offsetX = Math.cos(angle) * 25; offsetY = Math.sin(angle) * 25;
        }
        token.style.left = `calc(${pos.x}% + ${offsetX}px)`;
        token.style.top = `calc(${pos.y}% + ${offsetY}px)`;
        token.title = `${player.name}\n–ü–æ–∑–∏—Ü—ñ—è: ${player.position}\n–õ–æ–∫–∞—Ü—ñ—è: ${pos.type}`;
    });
}

// –í–ò–ü–†–ê–í–õ–ï–ù–Ü —Ñ—É–Ω–∫—Ü—ñ—ó —Ö–æ–¥—ñ–≤ –∑ –±–∞–≥–∞–º–∏!
function rollDice() {
    if (gameState.diceRolled) { alert('–í–∏ –≤–∂–µ –∫–∏–Ω—É–ª–∏ –∫—É–±–∏–∫ —Ü–∏–º —Ö–æ–¥–æ–º!'); return; }
    const roll = Math.floor(Math.random() * 6) + 1;
    document.getElementById('diceDisplay').innerHTML = `
        <div>üé≤ ${roll}</div>
        <div style="font-size: 0.4em; margin-top: 10px;">
            <button onclick="movePlayer(${roll})" class="success">‚û°Ô∏è –†—É—Ö–∞—Ç–∏—Å—è</button>
        </div>
    `;
    gameState.diceRolled = true;
    addLog(`${gameState.players[gameState.currentPlayerIndex].name} –∫–∏–Ω—É–≤: ${roll}`);
    updateDisplay();
}

function movePlayer(steps) {
    if (gameState.moveComplete) { alert('–í–∏ –≤–∂–µ –∑—Ä–æ–±–∏–ª–∏ —Ö—ñ–¥! –ó–∞–∫—ñ–Ω—á—ñ—Ç—å —Å–≤—ñ–π —Ö—ñ–¥.'); return; }
    const player = gameState.players[gameState.currentPlayerIndex];
    const oldPos = player.position;
    const newPos = Math.min(player.position + steps, 70);
    
    addLog(`${player.name} —Ä—É—Ö–∞—î—Ç—å—Å—è –Ω–∞ ${steps} –∫—Ä–æ–∫—ñ–≤: ${oldPos} ‚Üí ${newPos}`);
    
    // –ü–æ–∫—Ä–æ–∫–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è —Ä—É—Ö—É
    let currentStep = 0;
    const animateStep = () => {
        if (currentStep < steps && (oldPos + currentStep) < 70) {
            player.position = oldPos + currentStep + 1;
            updatePlayerTokens(true);
            currentStep++;
            setTimeout(animateStep, 300); // 300ms –º—ñ–∂ –∫—Ä–æ–∫–∞–º–∏
        } else {
            player.position = newPos;
            updatePlayerTokens(true);
            updateDisplay();
            setTimeout(() => { 
                document.getElementById('diceDisplay').innerHTML = ''; 
                handleLocation(); 
            }, 800);
        }
    };
    
    animateStep();
}

function handleLocation() {
    const player = gameState.players[gameState.currentPlayerIndex];
    const location = BOARD_POSITIONS[player.position];
    
    // –Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å —Å—Ç–æ—ó—Ç—å –Ω–∞ –º—ñ—Å—Ç—ñ, –¥–æ–∑–≤–æ–ª—è—î–º–æ –∑–∞–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ
    if (location.type === 'city') {
        handleCity();
        return;
    }
    
    switch(location.type) {
        case 'start': gameState.moveComplete = true; updateDisplay(); break;
        case 'castle': handleCastle(); break;
        case 'ruins': handleRuins(); break;
        case 'gold': handleGoldFind(location.amount || 1); break;
        case 'monster': handleMonster(location.level); break;
        case 'adventure': handleAdventure(); break;
        default: gameState.moveComplete = true; updateDisplay();
    }
}

function handleCastle() {
    const player = gameState.players[gameState.currentPlayerIndex];
    let hasWinCondition = false;
    let winningType = '';
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –ø–æ–≤–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Ç 1-5 —Ä—ñ–≤–Ω—è –æ–¥–Ω–æ–≥–æ —Ç–∏–ø—É
    ARTIFACT_TYPES.forEach(type => {
        const typeArtifacts = player.artifacts[type.name];
        let hasFullSet = true;
        
        for (let level = 1; level <= 5; level++) {
            if (!typeArtifacts[level] || typeArtifacts[level] < 1) {
                hasFullSet = false;
                break;
            }
        }
        
        if (hasFullSet) {
            hasWinCondition = true;
            winningType = type.name;
        }
    });
    
    if (hasWinCondition) {
        alert(`üéâ ${player.name} –ø–µ—Ä–µ–º—ñ–≥! –ó—ñ–±—Ä–∞–≤ –ø–æ–≤–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ ${winningType} (1‚òÖ-5‚òÖ)! –î—Ä–∞–∫—É–ª–∞ –ø–æ–≤–µ—Ä–∂–µ–Ω–∏–π!`);
    } else {
        alert('–í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ–≤–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø—É (1‚òÖ-5‚òÖ) —â–æ–± –ø–µ—Ä–µ–º–æ–≥—Ç–∏ –î—Ä–∞–∫—É–ª—É!\n\n–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–∞ —Å—Ç–∞—Ä—Ç...');
        player.position = 0; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ —Å—Ç–∞—Ä—Ç –∑–≥—ñ–¥–Ω–æ –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏
        updatePlayerTokens(true);
    }
    
    gameState.moveComplete = true; 
    updateDisplay();
}

function handleGoldFind(amount) {
    const player = gameState.players[gameState.currentPlayerIndex];
    let actualAmount = amount;
    if (player.hero === '–ù–∞–π–º–∞–Ω–µ—Ü—å') actualAmount += 2;
    player.gold += actualAmount;
    document.getElementById('goldModal').classList.add('active');
    document.getElementById('goldContent').innerHTML = `
        <p>–í–∏ –∑–Ω–∞–π—à–ª–∏ ${actualAmount} –∑–æ–ª–æ—Ç–∞! üí∞</p>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="closeModal('goldModal')">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        </div>
    `;
    addLog(`${player.name} –∑–Ω–∞–π—à–æ–≤ ${actualAmount} –∑–æ–ª–æ—Ç–∞!`);
}

function handleMonster(level) {
    const monsters = MONSTERS.filter(m => m.level === level);
    const monster = monsters[Math.floor(Math.random() * monsters.length)];
    document.getElementById('monsterModal').classList.add('active');
    document.getElementById('monsterContent').innerHTML = `
        <div style="text-align: center;">
            <h3>${monster.name} (–†—ñ–≤–µ–Ω—å ${monster.level})</h3>
            <p>–í–∏–±–µ—Ä—ñ—Ç—å —Å–≤–æ—é –¥—ñ—é:</p>
            <div style="margin-top: 20px;">
                <button onclick="fightMonster(${JSON.stringify(monster).replace(/"/g, '&quot;')})" class="success" style="margin: 5px;">‚öîÔ∏è –ë–∏—Ç–∏—Å—è</button>
                <button onclick="avoidMonster()" style="margin: 5px;">üèÉ –£–Ω–∏–∫–Ω—É—Ç–∏</button>
            </div>
        </div>
    `;
}

function fightMonster(monster) {
    const player = gameState.players[gameState.currentPlayerIndex];
    let playerPower = player.armor;
    let weaponBonus = 0;
    let weaponUsed = '';
    
    // –ë–æ–Ω—É—Å–∏ –≥–µ—Ä–æ—ó–≤
    if (player.hero === '–í–æ—ó–Ω' && monster.level >= 4) {
        playerPower += 1;
    }
    if (player.companions.some(c => c.name === '–í–æ–≤–∫') && monster.level <= 3) {
        playerPower += 1;
    }
    
    // –ë–æ–Ω—É—Å–∏ –≤—ñ–¥ –∑–±—Ä–æ—ó –∑–≥—ñ–¥–Ω–æ –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏
    if (monster.level === 2 && player.weapons.rope > 0) {
        weaponBonus = player.weapons.rope;
        weaponUsed = `–ú–æ—Ç—É–∑–∫–∞ x${player.weapons.rope}`;
    }
    if (monster.level === 3 && player.weapons.axe > 0) {
        weaponBonus = player.weapons.axe;
        weaponUsed = `–°–æ–∫–∏—Ä–∞ x${player.weapons.axe}`;
    }
    if (monster.level === 4 && player.weapons.dagger > 0) {
        weaponBonus = player.weapons.dagger;
        weaponUsed = `–ö–∏–Ω–∂–∞–ª x${player.weapons.dagger}`;
    }
    if (monster.level === 5 && player.weapons.ring > 0) {
        weaponBonus = player.weapons.ring;
        weaponUsed = `–ü–µ—Ä—Å—Ç–µ–Ω—å x${player.weapons.ring}`;
    }
    
    playerPower += weaponBonus;
    const roll = Math.floor(Math.random() * 6) + 1;
    const totalPower = roll + playerPower - player.armor; // –ó–∞–≥–∞–ª—å–Ω–∞ —Å–∏–ª–∞ –±–µ–∑ –±—Ä–æ–Ω—ñ
    const success = totalPower > monster.level; // –¢—Ä–µ–±–∞ –ü–ï–†–ï–í–ò–©–ò–¢–ò —Ä—ñ–≤–µ–Ω—å –º–æ–Ω—Å—Ç—Ä–∞
    
    let battleDetails = `
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h4>–î–µ—Ç–∞–ª—ñ –±–æ—é:</h4>
            <div style="margin: 10px 0;">üé≤ –ö–∏–¥–æ–∫ –∫—É–±–∏–∫–∞: <strong>${roll}</strong></div>
            <div style="margin: 10px 0;">üõ°Ô∏è –ë—Ä–æ–Ω—è: <strong>+${player.armor}</strong></div>
            ${weaponBonus > 0 ? `<div style="margin: 10px 0;">‚öîÔ∏è ${weaponUsed}: <strong>+${weaponBonus}</strong></div>` : ''}
            <div style="margin: 10px 0; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
                üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å–∏–ª–∞: <strong>${totalPower}</strong> –ø—Ä–æ—Ç–∏ <strong>${monster.level}</strong>
            </div>
        </div>
    `;
    
    if (success) {
        player.gold += monster.gold;
        const artifactLevel = Math.min(monster.level, 5);
        
        // –í–∏–±–∏—Ä–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —Ç–∏–ø –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É
        const randomType = ARTIFACT_TYPES[Math.floor(Math.random() * ARTIFACT_TYPES.length)];
        if (!player.artifacts[randomType.name][artifactLevel]) {
            player.artifacts[randomType.name][artifactLevel] = 0;
        }
        player.artifacts[randomType.name][artifactLevel]++;
        
        addLog(`${player.name} –ø–µ—Ä–µ–º—ñ–≥ ${monster.name}! (${totalPower} > ${monster.level})`);
        
        if (player.hero === '–ó–Ω–∞—Ö–∞—Ä') { 
            player.elixirs.speed++; 
            player.gold++; 
            addLog(`–ó–Ω–∞—Ö–∞—Ä –æ—Ç—Ä–∏–º—É—î –±–æ–Ω—É—Å: +1‚ö° +1üí∞`); 
        }
        
        document.getElementById('monsterContent').innerHTML = `
            <div style="text-align: center;">
                <h3>üéâ –ü–µ—Ä–µ–º–æ–≥–∞!</h3>
                ${battleDetails}
                <div style="background: rgba(0,255,0,0.2); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <div>üí∞ –û—Ç—Ä–∏–º–∞–Ω–æ –∑–æ–ª–æ—Ç–∞: +${monster.gold}</div>
                    <div>${randomType.icon} –û—Ç—Ä–∏–º–∞–Ω–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç: ${randomType.name} ${artifactLevel}‚òÖ</div>
                    ${player.hero === '–ó–Ω–∞—Ö–∞—Ä' ? '<div>üåø –ë–æ–Ω—É—Å –ó–Ω–∞—Ö–∞—Ä—è: +1‚ö° +1üí∞</div>' : ''}
                </div>
                <button onclick="closeModal('monsterModal')" class="success">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
            </div>
        `;
    } else {
        // –ö—É–±–∏–∫ —Å–º–µ—Ä—Ç—ñ - —Ç–µ—Å—Ç—É—î–º–æ –±—Ä–æ–Ω—é
        const deathRoll = Math.floor(Math.random() * 6) + 1;
        const survived = deathRoll <= player.armor;
        
        if (!survived) {
            player.health = Math.max(0, player.health - 1);
            addLog(`${player.name} –ø—Ä–æ–≥—Ä–∞–≤ –ø—Ä–æ—Ç–∏ ${monster.name}! –ö—É–±–∏–∫ —Å–º–µ—Ä—Ç—ñ: ${deathRoll} > ${player.armor} –±—Ä–æ–Ω—ñ. -1‚ù§Ô∏è`);
        } else {
            addLog(`${player.name} –ø—Ä–æ–≥—Ä–∞–≤ –ø—Ä–æ—Ç–∏ ${monster.name}, –∞–ª–µ –±—Ä–æ–Ω—è –≤—Ä—è—Ç—É–≤–∞–ª–∞! –ö—É–±–∏–∫ —Å–º–µ—Ä—Ç—ñ: ${deathRoll} ‚â§ ${player.armor} –±—Ä–æ–Ω—ñ.`);
        }
        
        document.getElementById('monsterContent').innerHTML = `
            <div style="text-align: center;">
                <h3>üíÄ –ü–æ—Ä–∞–∑–∫–∞!</h3>
                ${battleDetails}
                <div style="background: rgba(255,0,0,0.2); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <div>üíÄ –ö—É–±–∏–∫ —Å–º–µ—Ä—Ç—ñ: <strong>${deathRoll}</strong> –ø—Ä–æ—Ç–∏ <strong>${player.armor}</strong> –±—Ä–æ–Ω—ñ</div>
                    ${!survived ? '<div style="color: #ff6b6b;">üíî –í—Ç—Ä–∞—á–µ–Ω–æ 1‚ù§Ô∏è</div>' : '<div style="color: #90EE90;">üõ°Ô∏è –ë—Ä–æ–Ω—è –≤—Ä—è—Ç—É–≤–∞–ª–∞!</div>'}
                </div>
                <button onclick="closeModal('monsterModal')" class="success">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
            </div>
        `;
        
        if (player.health === 0) {
            setTimeout(() => alert(`üíÄ ${player.name} –∑–∞–≥–∏–Ω—É–≤!`), 500);
        }
    }
}

function avoidMonster() {
    addLog(`${gameState.players[gameState.currentPlayerIndex].name} —É–Ω–∏–∫–Ω—É–≤ –±–æ—é`);
    closeModal('monsterModal');
}

function handleRuins() {
    document.getElementById('ruinsModal').classList.add('active');
    document.getElementById('ruinsContent').innerHTML = `
        <div style="text-align: center;">
            <p>–í–∏ –¥–æ—Å–ª—ñ–¥–∂—É—î—Ç–µ –¥—Ä–µ–≤–Ω—ñ —Ä—É—ó–Ω–∏...</p>
            <div style="margin-top: 20px;">
                <button onclick="exploreRuins()" class="success">üîç –î–æ—Å–ª—ñ–¥–∏—Ç–∏</button>
                <button onclick="closeModal('ruinsModal')">üö™ –ü—ñ—Ç–∏ –≥–µ—Ç—å</button>
            </div>
        </div>
    `;
}

function exploreRuins() {
    const player = gameState.players[gameState.currentPlayerIndex];
    const outcomes = ['–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥', '–°—É–ø—É—Ç–Ω–∏–∫', '–ü–∞—Å—Ç–∫–∞', '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç 1‚òÖ'];
    let cardsToTake = player.hero === '–ê–ª—Ö—ñ–º—ñ–∫' ? 2 : 1;
    let results = [];
    
    for (let i = 0; i < cardsToTake; i++) {
        const outcome = outcomes[Math.floor(Math.random() * outcomes.length)];
        
        switch(outcome) {
            case '–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥':
                const cards = ['–¢–µ–ª–µ–ø–æ—Ä—Ç +3', '–õ—ñ–∫—É–≤–∞–Ω–Ω—è +1‚ù§Ô∏è', '–ü–æ–¥–≤—ñ–π–Ω–µ –∑–æ–ª–æ—Ç–æ', '–ë—Ä–æ–Ω—è +1', '–®–≤–∏–¥–∫—ñ—Å—Ç—å +1'];
                const card = cards[Math.floor(Math.random() * cards.length)];
                player.adventureCards.push(card); 
                addLog(`${player.name} –∑–Ω–∞–π—à–æ–≤ –∫–∞—Ä—Ç—É: ${card}`);
                results.push(`üÉè –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥: ${card}`);
                break;
            case '–°—É–ø—É—Ç–Ω–∏–∫':
                const companion = COMPANIONS[Math.floor(Math.random() * COMPANIONS.length)];
                if (!player.companions.find(c => c.name === companion.name)) {
                    player.companions.push(companion); 
                    addLog(`${player.name} –∑–Ω–∞–π—à–æ–≤ —Å—É–ø—É—Ç–Ω–∏–∫–∞: ${companion.name}`);
                    results.push(`üêæ –°—É–ø—É—Ç–Ω–∏–∫: ${companion.name} (${companion.ability})`);
                } else {
                    results.push(`üêæ –°—É–ø—É—Ç–Ω–∏–∫: ${companion.name} (–≤–∂–µ —î, —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è)`);
                }
                break;
            case '–ü–∞—Å—Ç–∫–∞': 
                player.health = Math.max(0, player.health - 1); 
                addLog(`${player.name} –ø–æ—Ç—Ä–∞–ø–∏–≤ —É –ø–∞—Å—Ç–∫—É! -1‚ù§Ô∏è`);
                results.push(`üéØ –ü–∞—Å—Ç–∫–∞! –í—Ç—Ä–∞—á–µ–Ω–æ 1‚ù§Ô∏è`);
                break;
            case '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç 1‚òÖ': 
                const randomType = ARTIFACT_TYPES[Math.floor(Math.random() * ARTIFACT_TYPES.length)];
                if (!player.artifacts[randomType.name][1]) {
                    player.artifacts[randomType.name][1] = 0;
                }
                player.artifacts[randomType.name][1]++;
                addLog(`${player.name} –∑–Ω–∞–π—à–æ–≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç 1‚òÖ`);
                results.push(`${randomType.icon} –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: ${randomType.name} 1‚òÖ`);
                break;
        }
    }
    
    // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è
    document.getElementById('ruinsContent').innerHTML = `
        <div style="text-align: center;">
            <h3>üè∫ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è:</h3>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                ${results.map(result => `<div style="margin: 8px 0; font-size: 1.1em;">${result}</div>`).join('')}
            </div>
            <button onclick="closeModal('ruinsModal')" class="success">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        </div>
    `;
}

function handleCity() {
    const player = gameState.players[gameState.currentPlayerIndex];
    const discount = player.hero === '–¢–æ—Ä–≥–æ–≤–µ—Ü—å' ? 3 : 0;
    document.getElementById('cityModal').classList.add('active');
    document.getElementById('cityContent').innerHTML = `
        <div style="text-align: center;">
            <h3>üèõÔ∏è –ú—ñ—Å—Ç–æ</h3><p>–©–æ –±–∞–∂–∞—î—Ç–µ –∫—É–ø–∏—Ç–∏?</p>
            <div style="margin-top: 20px;">
                <button onclick="buyItem('elixir', ${Math.max(1, 3 - discount)})" ${player.gold >= Math.max(1, 3 - discount) ? '' : 'disabled'}>‚ö° –ï–ª—ñ–∫—Å–∏—Ä —à–≤–∏–¥–∫–æ—Å—Ç—ñ (${Math.max(1, 3 - discount)}üí∞)</button><br>
                <button onclick="buyItem('luck', ${Math.max(1, 2 - discount)})" ${player.gold >= Math.max(1, 2 - discount) ? '' : 'disabled'}>üçÄ –°—É–≤—ñ–π —É–¥–∞—á—ñ (${Math.max(1, 2 - discount)}üí∞)</button><br>
                <button onclick="buyWeapon()" class="secondary">üó°Ô∏è –ö—É–ø–∏—Ç–∏ –∑–±—Ä–æ—é</button><br>
                <button onclick="closeModal('cityModal')" style="margin-top: 15px;">üö™ –ù—ñ—á–æ–≥–æ –Ω–µ –∫—É–ø—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    `;
}

function buyItem(type, cost) {
    const player = gameState.players[gameState.currentPlayerIndex];
    if (player.gold < cost) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–æ–ª–æ—Ç–∞!'); return; }
    player.gold -= cost;
    switch(type) {
        case 'elixir': 
            player.elixirs.speed++; 
            addLog(`${player.name} –∫—É–ø–∏–≤ –µ–ª—ñ–∫—Å–∏—Ä —à–≤–∏–¥–∫–æ—Å—Ç—ñ –∑–∞ ${cost}üí∞`); 
            break;
        case 'luck': 
            player.elixirs.luck++; 
            addLog(`${player.name} –∫—É–ø–∏–≤ —Å—É–≤—ñ–π —É–¥–∞—á—ñ –∑–∞ ${cost}üí∞`); 
            break;
    }
    closeModal('cityModal');
}

function buyWeapon() {
    const player = gameState.players[gameState.currentPlayerIndex];
    const discount = player.hero === '–¢–æ—Ä–≥–æ–≤–µ—Ü—å' ? 3 : 0;
    
    const weapons = [
        { name: '–ú–æ—Ç—É–∑–∫–∞', price: Math.max(1, 1 - discount), type: 'rope', level: 2 },
        { name: '–°–æ–∫–∏—Ä–∞', price: Math.max(1, 2 - discount), type: 'axe', level: 3 },
        { name: '–ö–∏–Ω–∂–∞–ª', price: Math.max(1, 3 - discount), type: 'dagger', level: 4 },
        { name: '–ü–µ—Ä—Å—Ç–µ–Ω—å', price: Math.max(1, 4 - discount), type: 'ring', level: 5 }
    ];
    
    document.getElementById('cityContent').innerHTML = `
        <div style="text-align: center;">
            <h3>üó°Ô∏è –ó–±—Ä–æ—è—Ä–Ω—è</h3>
            <p>–í–∏–±–µ—Ä—ñ—Ç—å –∑–±—Ä–æ—é –¥–ª—è –∫—É–ø—ñ–≤–ª—ñ:</p>
            <div style="margin-top: 20px;">
                ${weapons.map(weapon => `
                    <button onclick="buySpecificWeapon('${weapon.type}', ${weapon.price}, '${weapon.name}', ${weapon.level})" 
                            ${player.gold >= weapon.price ? '' : 'disabled'}
                            style="margin: 5px; width: 90%;">
                        ${weapon.name} - ${weapon.price}üí∞ (–ø—Ä–æ—Ç–∏ ${weapon.level}‚òÖ –º–æ–Ω—Å—Ç—Ä—ñ–≤)
                    </button><br>
                `).join('')}
                <button onclick="handleCity()" style="margin-top: 15px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –º–∞–≥–∞–∑–∏–Ω—É</button>
            </div>
        </div>
    `;
}

function buySpecificWeapon(type, cost, name, level) {
    const player = gameState.players[gameState.currentPlayerIndex];
    if (player.gold < cost) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–æ–ª–æ—Ç–∞!'); return; }
    
    player.gold -= cost;
    player.weapons[type]++;
    addLog(`${player.name} –∫—É–ø–∏–≤ ${name} –∑–∞ ${cost}üí∞ (–µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –ø—Ä–æ—Ç–∏ ${level}‚òÖ –º–æ–Ω—Å—Ç—Ä—ñ–≤)`);
    closeModal('cityModal');
}

function handleAdventure() {
    const cards = ['–¢–µ–ª–µ–ø–æ—Ä—Ç: +3 –∫—Ä–æ–∫–∏ –≤–ø–µ—Ä–µ–¥', '–õ—ñ–∫—É–≤–∞–Ω–Ω—è: +1‚ù§Ô∏è', '–ü–æ–¥–≤—ñ–π–Ω–µ –∑–æ–ª–æ—Ç–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞–∑—É', '–¢–∏–º—á–∞—Å–æ–≤–∞ –±—Ä–æ–Ω—è: +1üõ°Ô∏è', '–®–≤–∏–¥–∫—ñ—Å—Ç—å: +1 —Ö—ñ–¥ —Ü—å–æ–≥–æ —Ä–∞—É–Ω–¥—É', '–ü–æ—à—É–∫ —Å–∫–∞—Ä–±—ñ–≤: +2üí∞', '–ú–∞–≥—ñ—á–Ω–∏–π —â–∏—Ç: —ñ–º—É–Ω—ñ—Ç–µ—Ç –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —à–∫–æ–¥–∏', '–£–¥–∞—á–∞: –ø–µ—Ä–µ–∫–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫'];
    const card = cards[Math.floor(Math.random() * cards.length)];
    gameState.players[gameState.currentPlayerIndex].adventureCards.push(card);
    document.getElementById('adventureModal').classList.add('active');
    document.getElementById('adventureContent').innerHTML = `
        <div style="text-align: center;">
            <h3>üÉè –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥!</h3><p>–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏:</p>
            <div style="background: rgba(255,215,0,0.2); padding: 15px; border-radius: 8px; margin: 15px 0;"><strong>${card}</strong></div>
            <button onclick="closeModal('adventureModal')">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        </div>
    `;
    addLog(`${gameState.players[gameState.currentPlayerIndex].name} –æ—Ç—Ä–∏–º–∞–≤ –∫–∞—Ä—Ç—É: ${card}`);
}

function showInventory() {
    const player = gameState.players[gameState.currentPlayerIndex];
    document.getElementById('inventoryModal').classList.add('active');
    document.getElementById('inventoryContent').innerHTML = `
        <h3>üõ°Ô∏è –ó–±—Ä–æ—è</h3>
        <div class="inventory-grid">
            <div class="inventory-item"><div>–ú–æ—Ç—É–∑–∫–∞</div><div class="count">${player.weapons.rope}</div></div>
            <div class="inventory-item"><div>–°–æ–∫–∏—Ä–∞</div><div class="count">${player.weapons.axe}</div></div>
            <div class="inventory-item"><div>–ö–∏–Ω–∂–∞–ª</div><div class="count">${player.weapons.dagger}</div></div>
            <div class="inventory-item"><div>–ü–µ—Ä—Å—Ç–µ–Ω—å</div><div class="count">${player.weapons.ring}</div></div>
        </div>
        <h3 style="margin-top: 20px;">‚ú® –ú–∞–≥—ñ—á–Ω—ñ –ø—Ä–µ–¥–º–µ—Ç–∏</h3>
        <div class="inventory-grid">
            <div class="inventory-item ${player.elixirs.speed > 0 ? 'usable' : ''}" onclick="${player.elixirs.speed > 0 && !gameState.diceRolled && !gameState.moveComplete ? 'useSpeedElixir()' : ''}">
                <div>‚ö° –ï–ª—ñ–∫—Å–∏—Ä</div><div class="count">${player.elixirs.speed}</div>
            </div>
            <div class="inventory-item ${player.elixirs.luck > 0 ? 'usable' : ''}"><div>üçÄ –°—É–≤—ñ–π</div><div class="count">${player.elixirs.luck}</div></div>
        </div>
        <h3 style="margin-top: 20px;">üÉè –ö–∞—Ä—Ç–∏ –ø—Ä–∏–≥–æ–¥ (${player.adventureCards.length})</h3>
        <div style="max-height: 200px; overflow-y: auto;">
            ${player.adventureCards.map((card, i) => `<div class="inventory-item" style="margin: 5px 0;"><span>${card}</span><button onclick="useAdventureCard(${i})" style="padding: 5px 10px; font-size: 0.9em;">–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏</button></div>`).join('')}
        </div>
        <div style="text-align: center; margin-top: 20px;"><button onclick="closeModal('inventoryModal')">–ó–∞–∫—Ä–∏—Ç–∏</button></div>
    `;
}

function useSpeedElixir() {
    const player = gameState.players[gameState.currentPlayerIndex];
    if (player.elixirs.speed > 0 && !gameState.diceRolled && !gameState.moveComplete) {
        player.elixirs.speed--;
        if (player.companions.some(c => c.name === '–ë—ñ–ª–∫–∞')) player.gold++;
        addLog(`${player.name} –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –µ–ª—ñ–∫—Å–∏—Ä!`);
        closeModal('inventoryModal'); rollDice();
    }
}

function useAdventureCard(index) {
    const player = gameState.players[gameState.currentPlayerIndex];
    const card = player.adventureCards[index];
    player.adventureCards.splice(index, 1);
    addLog(`${player.name} –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –∫–∞—Ä—Ç—É: ${card}`);
    if (card.includes('–¢–µ–ª–µ–ø–æ—Ä—Ç')) { player.position = Math.min(player.position + 3, BOARD_POSITIONS.length - 1); updatePlayerTokens(true); }
    else if (card.includes('–õ—ñ–∫—É–≤–∞–Ω–Ω—è')) player.health = Math.min(3, player.health + 1);
    else if (card.includes('–ü–æ–¥–≤—ñ–π–Ω–µ –∑–æ–ª–æ—Ç–æ')) player.gold *= 2;
    closeModal('inventoryModal'); updateDisplay();
}

function showAbilities() {
    const player = gameState.players[gameState.currentPlayerIndex];
    let html = `<h3>‚≠ê –í–º—ñ–Ω–Ω—è –≥–µ—Ä–æ—è: ${player.hero}</h3><div class="ability-btn ${player.heroData.abilityType === 'passive' ? 'disabled' : ''}"><strong>${player.heroData.ability}</strong><div style="font-size: 0.85em; color: #aaa; margin-top: 5px;">${player.heroData.abilityType === 'passive' ? '(–ü–∞—Å–∏–≤–Ω–µ - –∑–∞–≤–∂–¥–∏ –∞–∫—Ç–∏–≤–Ω–µ)' : '(–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è)'}</div></div>`;
    if (player.companions.length > 0) {
        html += '<h3 style="margin-top: 20px;">üêæ –í–º—ñ–Ω–Ω—è —Å—É–ø—É—Ç–Ω–∏–∫—ñ–≤</h3>';
        player.companions.forEach((companion, i) => {
            html += `<div class="ability-btn ${companion.type === 'passive' ? 'disabled' : ''}" onclick="${companion.type === 'active' ? `useCompanionAbility(${i})` : ''}"><strong>${companion.name}</strong><div style="font-size: 0.85em; color: #aaa; margin-top: 5px;">${companion.ability} ${companion.type === 'passive' ? ' (–ü–∞—Å–∏–≤–Ω–µ)' : ' (–ê–∫—Ç–∏–≤–Ω–µ)'}</div></div>`;
        });
    }
    if (player.hero === '–ö—É–∑–Ω–µ—Ü—å') html += `<h3 style="margin-top: 20px;">üî® –ö–æ–≤–∞–ª—å—Å—Ç–≤–æ</h3><button onclick="smithCraft()" class="success" style="width: 100%;">–û–±'—î–¥–Ω–∞—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏</button>`;
    if (player.hero === '–ú–∞–≥' && player.usedLuckScrolls.length > 0) html += `<h3 style="margin-top: 20px;">üîÆ –ú–∞–≥—ñ—è</h3><button onclick="magRecycleLuck()" class="success" style="width: 100%;">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å—É–≤—ñ–π —É–¥–∞—á—ñ (${player.usedLuckScrolls.length})</button>`;
    html += `<div style="text-align: center; margin-top: 20px;"><button onclick="closeModal('abilitiesModal')">–ó–∞–∫—Ä–∏—Ç–∏</button></div>`;
    document.getElementById('abilitiesContent').innerHTML = html;
    document.getElementById('abilitiesModal').classList.add('active');
}

function useCompanionAbility(index) {
    const player = gameState.players[gameState.currentPlayerIndex];
    const companion = player.companions[index];
    addLog(`${player.name} –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –≤–º—ñ–Ω–Ω—è: ${companion.name}`);
    if (companion.name === '–Ñ–¥–∏–Ω–æ—Ä—ñ–≥') alert('–ü–æ–º—ñ–Ω—è–π—Ç–µ –º—ñ—Å—Ü—è–º–∏ —Ü–∏—Ñ—Ä–∏ —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∫–∏–¥–∫—É –∫—É–±–∏–∫–∞');
    else if (companion.name === '–ì—Ä–∏—Ñ–æ–Ω') {
        for (let i = player.position + 1; i < BOARD_POSITIONS.length; i++) {
            if (BOARD_POSITIONS[i].type === 'monster') { player.position = i; updatePlayerTokens(true); setTimeout(() => handleLocation(), 1200); break; }
        }
    } else if (companion.name === '–ö—ñ–Ω—å') { player.position = Math.min(player.position + 2, BOARD_POSITIONS.length - 1); updatePlayerTokens(true); }
    closeModal('abilitiesModal'); updateDisplay();
}

function smithCraft() { alert('–í–∏–±–µ—Ä—ñ—Ç—å 2 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –æ–¥–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è –¥–ª—è –æ–±\'—î–¥–Ω–∞–Ω–Ω—è –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è'); closeModal('abilitiesModal'); }

function magRecycleLuck() {
    const player = gameState.players[gameState.currentPlayerIndex];
    const count = player.usedLuckScrolls.length;
    player.elixirs.luck += count; player.usedLuckScrolls = [];
    addLog(`${player.name} –≤—ñ–¥–Ω–æ–≤–∏–≤ ${count} —Å—É–≤–æ—ó–≤!`);
    closeModal('abilitiesModal'); updateDisplay();
}

function enterCityFromLocation() {
    handleCity();
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    if (!gameState.moveComplete) gameState.moveComplete = true;
    updateDisplay();
}

function endTurn() {
    gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
    gameState.diceRolled = false; gameState.moveComplete = false;
    document.getElementById('diceDisplay').innerHTML = '';
    updateDisplay(); addLog(`--- ${gameState.players[gameState.currentPlayerIndex].name} ---`);
}

function addLog(message) {
    const log = document.getElementById('gameLog'), entry = document.createElement('div');
    entry.className = 'log-entry'; entry.textContent = message;
    log.insertBefore(entry, log.firstChild);
    while (log.children.length > 30) log.removeChild(log.lastChild);
}

window.addEventListener('load', () => { loadBoardImage(); updateHeroSelection(); });
    </script>
</body>
</html>